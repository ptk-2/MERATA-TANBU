<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelebihan Pegawai - Admin Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { display: flex; min-height: 100vh; background-color: #f8f9fa; }
        .sidebar { width: 250px; background-color: #343a40; color: white; position: fixed; height: 100%; padding-top: 20px; }
        .sidebar a { color: #adb5bd; text-decoration: none; display: block; padding: 10px 20px; }
        .sidebar a:hover, .sidebar a.active { color: white; background-color: #495057; }
        .sidebar .nav-link i { margin-right: 10px; }
        .content { margin-left: 250px; padding: 20px; width: calc(100% - 250px); }
        #form-step-2 { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h4 class="text-center mb-4">Admin Panel</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="admin.html"><i class="bi bi-speedometer2"></i>Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="persetujuan.html"><i class="bi bi-check2-circle"></i>Persetujuan</a></li>
            <li class="nav-item"><a class="nav-link" href="kekurangan-pegawai.html"><i class="bi bi-building-dash"></i>Kekurangan Pegawai</a></li>
            <li class="nav-item"><a class="nav-link active" href="kelebihan-pegawai.html"><i class="bi bi-building-add"></i>Kelebihan Pegawai</a></li>
            <li class="nav-item"><a class="nav-link" href="periode.html"><i class="bi bi-calendar-range"></i>Kelola Periode</a></li>
            <li class="nav-item"><a class="nav-link" href="kelola-pegawai.html"><i class="bi bi-people"></i>Kelola Pegawai</a></li>
            <li class="nav-item mt-auto"><a class="nav-link" href="login.html" id="logout-button"><i class="bi bi-box-arrow-left"></i>Logout</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Data Kelebihan Pegawai</h1>
                <h5 class="text-muted" id="periode-info">Memuat periode aktif...</h5>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#surplusModal" id="btn-tambah-data" disabled>
                <i class="bi bi-plus-circle"></i> Tambah Data
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Nama Sekolah</th>
                            <th>Kecamatan</th>
                            <th>Jabatan</th>
                            <th class="text-center">Jumlah Kelebihan</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="surplus-table-body">
                        </tbody>
                </table>
            </div>
        </div>
        
        <footer class="text-center mt-5"><hr><p>&copy; 2025 Dinas Pendidikan Kabupaten Tanah Bumbu.</p></footer>
    </div>
    
    <div class="modal fade" id="surplusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surplusModalLabel">Tambah Data Kelebihan Pegawai</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="surplus-form">
                        <input type="hidden" id="id-sekolah">
                        <div class="mb-3">
                            <label for="npsn" class="form-label"><b>Langkah 1:</b> Masukkan NPSN Sekolah</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="npsn" required>
                                <button class="btn btn-outline-secondary" type="button" id="btn-cek-npsn">Cek</button>
                            </div>
                            <div id="npsn-feedback" class="form-text mt-2"></div>
                        </div>
                        <hr>
                        <div id="form-step-2">
                            <p class="form-label"><b>Langkah 2:</b> Lengkapi Detail Kelebihan</p>
                            <fieldset disabled>
                                <div class="mb-3"><label class="form-label">Nama Sekolah</label><input type="text" class="form-control" id="nama-sekolah-readonly"></div>
                            </fieldset>
                            <div class="mb-3">
                                <label for="jabatan" class="form-label">Jabatan yang Berlebih</label>
                                <select class="form-select" id="jabatan" required>
                                    <option value="" selected disabled>Pilih Jabatan...</option>
                                    <option value="Guru Kelas">Guru Kelas</option>
                                    <option value="Kepala Sekolah">Kepala Sekolah</option>
                                    <option value="Tenaga Administrasi">Tenaga Administrasi</option>
                                    <option value="Penjaga Sekolah">Penjaga Sekolah</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="jumlah-kelebihan" class="form-label">Jumlah Kelebihan</label>
                                <input type="number" class="form-control" id="jumlah-kelebihan" required value="1">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary" form="surplus-form" id="btn-simpan">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Pengecekan status login admin
        if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
            alert('Anda harus login terlebih dahulu untuk mengakses halaman ini!');
            window.location.href = 'login.html';
        }
        
        const supabaseUrl = 'https://yghywsrqhgbaryqgdxkv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnaHl3c3JxaGdiYXJ5cWdkeGt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDM3MDgsImV4cCI6MjA3NDgxOTcwOH0.4lPp4zgqoTIFbOXZCtMRkgS8PzNnyDfTg5W0vsdwpR8';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        const surplusForm = document.getElementById('surplus-form');
        const surplusModal = new bootstrap.Modal(document.getElementById('surplusModal'));
        const btnTambahData = document.getElementById('btn-tambah-data');
        const periodeInfo = document.getElementById('periode-info');
        const tableBody = document.getElementById('surplus-table-body');
        const formStep2 = document.getElementById('form-step-2');
        const btnCekNpsn = document.getElementById('btn-cek-npsn');
        let activePeriode = null;

        async function initializePage() {
            const { data, error } = await supabaseClient.from('periode_pemetaan').select('*').eq('status', 'Aktif').single();
            if (data) {
                activePeriode = data;
                periodeInfo.textContent = `Periode Aktif: ${activePeriode.nama_periode} (${activePeriode.tahun})`;
                btnTambahData.disabled = false;
                getKelebihanPegawai();
            } else {
                periodeInfo.innerHTML = `Tidak ada periode aktif. Silakan <a href="periode.html">buat atau aktifkan</a> periode.`;
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Pilih periode aktif untuk melihat data.</td></tr>`;
            }
        }

        async function getKelebihanPegawai() {
            if (!activePeriode) return;
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';
            const { data, error } = await supabaseClient.from('kelebihan_pegawai').select(`*, sekolah(*)`).eq('id_periode', activePeriode.id).order('id', { ascending: false });
            
            if (error) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>`; return; }
            if (data.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center">Belum ada data kelebihan pegawai untuk periode ini.</td></tr>`; return; }

            tableBody.innerHTML = ''; 
            data.forEach(item => {
                const row = `<tr><td>${item.sekolah.nama_sekolah}</td><td>${item.sekolah.kecamatan}</td><td>${item.jabatan}</td><td class="text-center">${item.jumlah_kelebihan}</td><td class="text-center"><button class="btn btn-danger btn-sm btn-delete" data-id="${item.id}" title="Hapus"><i class="bi bi-trash"></i></button></td></tr>`;
                tableBody.innerHTML += row;
            });
        }

        btnCekNpsn.addEventListener('click', async () => {
            const npsn = document.getElementById('npsn').value.trim();
            const feedbackEl = document.getElementById('npsn-feedback');
            const namaSekolahEl = document.getElementById('nama-sekolah-readonly');
            const idSekolahInput = document.getElementById('id-sekolah');
            if (!npsn) { feedbackEl.textContent = 'NPSN tidak boleh kosong.'; return; }
            feedbackEl.textContent = 'Mencari...';
            formStep2.style.display = 'none';
            namaSekolahEl.value = '';
            idSekolahInput.value = '';
            const { data, error } = await supabaseClient.from('sekolah').select('id, nama_sekolah').eq('npsn', npsn).single();
            if (data) {
                feedbackEl.textContent = 'Sekolah ditemukan.';
                namaSekolahEl.value = data.nama_sekolah;
                idSekolahInput.value = data.id;
                formStep2.style.display = 'block';
            } else {
                feedbackEl.textContent = 'Sekolah dengan NPSN ini tidak ditemukan.';
            }
        });
        
        document.getElementById('btn-tambah-data').addEventListener('click', () => {
            surplusForm.reset();
            formStep2.style.display = 'none';
            document.getElementById('npsn-feedback').textContent = '';
        });

        surplusForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const idSekolah = document.getElementById('id-sekolah').value;
            if (!idSekolah) { alert('Cek NPSN terlebih dahulu hingga sekolah ditemukan.'); return; }
            const formData = {
                id_sekolah: idSekolah,
                id_periode: activePeriode.id,
                jabatan: document.getElementById('jabatan').value,
                jumlah_kelebihan: parseInt(document.getElementById('jumlah-kelebihan').value)
            };
            const { error } = await supabaseClient.from('kelebihan_pegawai').insert([formData]);
            if (error) { console.error(error); alert('Gagal menyimpan data!'); } else { surplusModal.hide(); getKelebihanPegawai(); }
        });
        
        tableBody.addEventListener('click', async (event) => {
            const target = event.target.closest('button.btn-delete');
            if (target) {
                const id = target.dataset.id;
                if (confirm('Anda yakin ingin menghapus data ini?')) {
                    const { error } = await supabaseClient.from('kelebihan_pegawai').delete().eq('id', id);
                    if (error) { alert('Gagal menghapus data!'); } else { getKelebihanPegawai(); }
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', initializePage);
        document.getElementById('logout-button').addEventListener('click', (event) => {
            event.preventDefault(); 
            sessionStorage.removeItem('adminAuthenticated'); 
            window.location.href = 'login.html'; 
        });
    </script>
</body>
</html>