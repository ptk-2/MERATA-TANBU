<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi - MERATA-TANBU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { 
            max-width: 500px; /* Anda bisa sesuaikan lebar maksimum di sini */
            width: 100%; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card p-4 shadow-sm login-box">
            <div class="card-body text-center">

                <img src="https://yghywsrqhgbaryqgdxkv.supabase.co/storage/v1/object/public/dokumen-aplikasi-MERATA/MERATA%202.png" class="img-fluid mb-4" alt="Header MERATA TANBU" style="max-width: 400px;">

                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg text-center" id="login-npsn" placeholder="Masukkan NPSN Unit Kerja Anda...">
                </div>
                <button class="btn btn-primary w-100" id="btn-cari-npsn">Cek Unit Kerja</button>
                
                <div id="pegawai-selection" class="mt-4" style="display: none;">
                    <hr>
                    <p class="text-muted">Unit kerja terverifikasi. Silakan pilih nama Anda.</p>
                    <select class="form-select form-select-lg" id="nama-pegawai-select"></select>
                </div>

                <div id="edit-nama-section" class="mt-4" style="display: none;">
                    <hr>
                    <p class="text-muted">Periksa kembali nama lengkap Anda. Anda bisa menambahkan gelar jika perlu.</p>
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg" id="nama-pegawai-edit">
                    </div>
                    <button class="btn btn-success w-100" id="btn-simpan-masuk">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Simpan & Masuk
                    </button>
                </div>

                <div id="login-feedback" class="form-text text-danger mt-2"></div>
            </div>
        </div>
    </div>
    <script>
        // --- Seluruh kode JavaScript tetap sama, tidak perlu diubah ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof supabase === 'undefined') {
                alert('ERROR Kritis: Library Supabase gagal dimuat. Periksa koneksi internet Anda atau coba muat ulang halaman.');
                document.getElementById('login-feedback').textContent = 'Gagal memuat komponen inti aplikasi. Periksa koneksi internet.';
                return;
            }

            const supabaseUrl = 'https://yghywsrqhgbaryqgdxkv.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnaHl3c3JxaGdiYXJ5cWdkeGt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDM3MDgsImV4cCI6MjA3NDgxOTcwOH0.4lPp4zgqoTIFbOXZCtMRkgS8PzNnyDfTg5W0vsdwpR8';
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

            const btnCariNpsn = document.getElementById('btn-cari-npsn');
            const npsnInput = document.getElementById('login-npsn');
            const pegawaiSelection = document.getElementById('pegawai-selection');
            const namaPegawaiSelect = document.getElementById('nama-pegawai-select');
            const loginFeedback = document.getElementById('login-feedback');
            
            const editNamaSection = document.getElementById('edit-nama-section');
            const namaPegawaiEditInput = document.getElementById('nama-pegawai-edit');
            const btnSimpanMasuk = document.getElementById('btn-simpan-masuk');

            btnCariNpsn.addEventListener('click', async () => {
                npsnInput.disabled = true;
                btnCariNpsn.disabled = true;
                loginFeedback.textContent = 'Memverifikasi...';
                pegawaiSelection.style.display = 'none';
                editNamaSection.style.display = 'none';

                try {
                    const npsn = npsnInput.value.trim();
                    if (!npsn) throw new Error('NPSN tidak boleh kosong.');
                    
                    const { data: periode } = await supabaseClient.from('periode_pemetaan').select('id').eq('status', 'Aktif').single();
                    if (!periode) throw new Error('Saat ini tidak ada periode pemetaan yang aktif.');
                    
                    const { data: sekolah } = await supabaseClient.from('sekolah').select('id, nama_sekolah').eq('npsn', npsn).single();
                    if (!sekolah) throw new Error('NPSN unit kerja tidak ditemukan.');

                    const { data: kelebihan } = await supabaseClient.from('kelebihan_pegawai').select('id').eq('id_sekolah', sekolah.id).eq('id_periode', periode.id).limit(1);
                    if (!kelebihan || kelebihan.length === 0) throw new Error('Unit kerja ini tidak terdata memiliki kelebihan pegawai pada periode ini.');
                    
                    const { data: appliedPegawaiIds } = await supabaseClient.from('aplikasi_penempatan').select('id_pegawai').eq('id_periode', periode.id);
                    const appliedIds = appliedPegawaiIds.map(item => item.id_pegawai);

                    const query = supabaseClient.from('pegawai').select('id, nama').eq('id_sekolah', sekolah.id);
                    if (appliedIds.length > 0) {
                        query.not('id', 'in', `(${appliedIds.join(',')})`);
                    }
                    const { data: pegawaiList } = await query;
                    if (!pegawaiList || pegawaiList.length === 0) throw new Error('Semua pegawai di unit kerja ini sudah mengajukan permohonan.');
                    
                    namaPegawaiSelect.innerHTML = '<option selected disabled value="">Pilih Nama Anda...</option>';
                    pegawaiList.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.nama;
                        namaPegawaiSelect.appendChild(option);
                    });

                    sessionStorage.setItem('sekolahNama', sekolah.nama_sekolah);
                    loginFeedback.textContent = '';
                    pegawaiSelection.style.display = 'block';

                } catch (error) {
                    loginFeedback.textContent = error.message;
                } finally {
                    npsnInput.disabled = false;
                    btnCariNpsn.disabled = false;
                }
            });

            namaPegawaiSelect.addEventListener('change', () => {
                const selectedOption = namaPegawaiSelect.options[namaPegawaiSelect.selectedIndex];
                if (selectedOption.disabled) {
                    editNamaSection.style.display = 'none';
                    return;
                }
                namaPegawaiEditInput.value = selectedOption.textContent;
                editNamaSection.style.display = 'block';
            });

            btnSimpanMasuk.addEventListener('click', async () => {
                const spinner = btnSimpanMasuk.querySelector('.spinner-border');
                const idPegawai = namaPegawaiSelect.value;
                const namaBaru = namaPegawaiEditInput.value.trim();

                if (!idPegawai) {
                    loginFeedback.textContent = 'Silakan pilih nama Anda terlebih dahulu.';
                    return;
                }
                if (!namaBaru) {
                    loginFeedback.textContent = 'Nama tidak boleh kosong.';
                    return;
                }
                
                btnSimpanMasuk.disabled = true;
                spinner.style.display = 'inline-block';
                loginFeedback.textContent = '';
                
                try {
                    const { error } = await supabaseClient
                        .from('pegawai')
                        .update({ nama: namaBaru })
                        .eq('id', idPegawai);

                    if (error) throw error;

                    sessionStorage.setItem('idPegawai', idPegawai);
                    sessionStorage.setItem('namaPegawai', namaBaru);
                    window.location.href = 'index.html';

                } catch (error) {
                    loginFeedback.textContent = `Gagal menyimpan nama: ${error.message}`;
                    btnSimpanMasuk.disabled = false;
                    spinner.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>